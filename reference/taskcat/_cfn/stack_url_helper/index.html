
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="https://raw.githubusercontent.com/aws-ia/taskcat/main/assets/docs/images/tcat.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.0">
    
    
      
        <title>Stack Url Helper - taskcat</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../../docs/custom.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="orange">
  
    
    <script>function __prefix(e){return new URL("../../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-taskcat_cfnstack_url_helper" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="taskcat" class="md-header__button md-logo" aria-label="taskcat" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/aws-ia/taskcat/main/assets/docs/images/tcat.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            taskcat
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Stack Url Helper
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws-ia/taskcat/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    taskcat
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="taskcat" class="md-nav__button md-logo" aria-label="taskcat" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/aws-ia/taskcat/main/assets/docs/images/tcat.png" alt="logo">

    </a>
    taskcat
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-ia/taskcat/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    taskcat
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/INSTALLATION/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/usage/GENERAL_USAGE/" class="md-nav__link">
        General Usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/usage/PARAMETER_OVERRIDES/" class="md-nav__link">
        Parameter Overrides
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/usage/PSUEDO_PARAMETERS/" class="md-nav__link">
        Psuedo Parameters
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/schema/taskcat_schema/" class="md-nav__link">
        Configuration Schema
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Administrative
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Administrative" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Administrative
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/administrative/CODE_OF_CONDUCT/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/administrative/CONTRIBUTING/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../taskcat_plugin_testhook/" class="md-nav__link">
        Taskcat Plugin Testhook
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2">
          Taskcat
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Taskcat" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Taskcat
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../exceptions/" class="md-nav__link">
        Exceptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../local_zones/" class="md-nav__link">
        Local Zones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../regions_to_partitions/" class="md-nav__link">
        Regions To Partitions
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_5" type="checkbox" id="__nav_6_2_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_5">
           Cfn
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label=" Cfn" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_5">
          <span class="md-nav__icon md-icon"></span>
           Cfn
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stack/" class="md-nav__link">
        Stack
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Stack Url Helper
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Stack Url Helper
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stackurlhelper" class="md-nav__link">
    StackURLHelper
  </a>
  
    <nav class="md-nav" aria-label="StackURLHelper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-methods" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_getatt" class="md-nav__link">
    evaluate_fn_getatt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_if" class="md-nav__link">
    evaluate_fn_if
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_join" class="md-nav__link">
    evaluate_fn_join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_split" class="md-nav__link">
    evaluate_fn_split
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_sub_vars_with_values" class="md-nav__link">
    rewrite_sub_vars_with_values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values_to_dict" class="md-nav__link">
    values_to_dict
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_expression_controller" class="md-nav__link">
    evaluate_expression_controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_findinmap" class="md-nav__link">
    evaluate_fn_findinmap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_ref" class="md-nav__link">
    evaluate_fn_ref
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_sub" class="md-nav__link">
    evaluate_fn_sub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_string" class="md-nav__link">
    evaluate_string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find_in_map_lookup" class="md-nav__link">
    find_in_map_lookup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find_local_child_template" class="md-nav__link">
    find_local_child_template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flatten_template_url" class="md-nav__link">
    flatten_template_url
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_sub_vars" class="md-nav__link">
    rewrite_sub_vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_vars" class="md-nav__link">
    rewrite_vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_url_to_path" class="md-nav__link">
    template_url_to_path
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../template/" class="md-nav__link">
        Template
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../threaded/" class="md-nav__link">
        Threaded
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_6" type="checkbox" id="__nav_6_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_6">
           Cli Modules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label=" Cli Modules" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_6">
          <span class="md-nav__icon md-icon"></span>
           Cli Modules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/config/" class="md-nav__link">
        Config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/delete/" class="md-nav__link">
        Delete
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/deploy/" class="md-nav__link">
        Deploy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/generate_iam_policy/" class="md-nav__link">
        Generate Iam Policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/lint/" class="md-nav__link">
        Lint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/list/" class="md-nav__link">
        List
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/package/" class="md-nav__link">
        Package
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/test/" class="md-nav__link">
        Test
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/update_ami/" class="md-nav__link">
        Update Ami
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../_cli_modules/upload/" class="md-nav__link">
        Upload
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_7" type="checkbox" id="__nav_6_2_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_7">
          Iam Policy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Iam Policy" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_7">
          <span class="md-nav__icon md-icon"></span>
          Iam Policy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../iam_policy/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../iam_policy/policy/" class="md-nav__link">
        Policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../iam_policy/tools/" class="md-nav__link">
        Tools
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_8" type="checkbox" id="__nav_6_2_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_8">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Testing" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_8">
          <span class="md-nav__icon md-icon"></span>
          Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/base_test/" class="md-nav__link">
        Base Test
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stackurlhelper" class="md-nav__link">
    StackURLHelper
  </a>
  
    <nav class="md-nav" aria-label="StackURLHelper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-variables" class="md-nav__link">
    Class variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-methods" class="md-nav__link">
    Static methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_getatt" class="md-nav__link">
    evaluate_fn_getatt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_if" class="md-nav__link">
    evaluate_fn_if
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_join" class="md-nav__link">
    evaluate_fn_join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_split" class="md-nav__link">
    evaluate_fn_split
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_sub_vars_with_values" class="md-nav__link">
    rewrite_sub_vars_with_values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values_to_dict" class="md-nav__link">
    values_to_dict
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_expression_controller" class="md-nav__link">
    evaluate_expression_controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_findinmap" class="md-nav__link">
    evaluate_fn_findinmap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_ref" class="md-nav__link">
    evaluate_fn_ref
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_fn_sub" class="md-nav__link">
    evaluate_fn_sub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate_string" class="md-nav__link">
    evaluate_string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find_in_map_lookup" class="md-nav__link">
    find_in_map_lookup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find_local_child_template" class="md-nav__link">
    find_local_child_template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flatten_template_url" class="md-nav__link">
    flatten_template_url
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_sub_vars" class="md-nav__link">
    rewrite_sub_vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite_vars" class="md-nav__link">
    rewrite_vars
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_url_to_path" class="md-nav__link">
    template_url_to_path
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-ia/taskcat/edit/main/reference/taskcat/_cfn/stack_url_helper.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="module-taskcat_cfnstack_url_helper">Module taskcat._cfn.stack_url_helper</h1>
<p>Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this
software and associated documentation files (the "Software"), to deal in the Software
without restriction, including without limitation the rights to use, copy, modify,
merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</span>

<span class="sd">  Permission is hereby granted, free of charge, to any person obtaining a copy of this</span>

<span class="sd">  software and associated documentation files (the &quot;Software&quot;), to deal in the Software</span>

<span class="sd">  without restriction, including without limitation the rights to use, copy, modify,</span>

<span class="sd">  merge, publish, distribute, sublicense, and/or sell copies of the Software, and to</span>

<span class="sd">  permit persons to whom the Software is furnished to do so.</span>

<span class="sd">  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,</span>

<span class="sd">  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A</span>

<span class="sd">  PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span>

<span class="sd">  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span>

<span class="sd">  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>

<span class="sd">  SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StackURLHelper</span><span class="p">:</span>

    <span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Handle at most 20 levels of nesting in TemplateURL expressions</span>

    <span class="c1"># TODO: Allow user to inject this</span>

    <span class="c1"># SUBSTITUTION = {</span>

    <span class="c1">#     &quot;QSS3BucketName&quot;: &quot;aws-quickstart&quot;,</span>

    <span class="c1">#     &quot;QSS3KeyPrefix&quot;: &quot;QSS3KeyPrefix/&quot;,</span>

    <span class="c1">#     &quot;qss3KeyPrefix&quot;: &quot;qss3KeyPrefix/&quot;,</span>

    <span class="c1">#     &quot;AWS::Region&quot;: &quot;us-east-1&quot;,</span>

    <span class="c1">#     &quot;AWS::AccountId&quot;: &quot;8888XXXX9999&quot;,</span>

    <span class="c1"># }</span>

    <span class="n">SUBSTITUTION</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s2">&quot;AWS::Region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>

        <span class="s2">&quot;AWS::URLSuffix&quot;</span><span class="p">:</span> <span class="s2">&quot;amazonaws.com&quot;</span><span class="p">,</span>

        <span class="s2">&quot;AWS::AccountId&quot;</span><span class="p">:</span> <span class="s2">&quot;8888XXXX9999&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">template_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

        <span class="n">template_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

        <span class="n">parameter_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

    <span class="p">):</span>

        <span class="k">if</span> <span class="n">template_mappings</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="n">template_mappings</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">template_parameters</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="n">template_parameters</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">parameter_values</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span> <span class="o">=</span> <span class="n">parameter_values</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">default_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">:</span>

            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;Default&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">default_parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Default&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rewrite_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the ${var} placeholders with ##var##&quot;&quot;&quot;</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;${&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">rewrite_sub_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the &#39;##var##&#39; placeholders with &#39;var&#39;&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_string</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">original_string</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># Recurse if we have more variables</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">expression</span>

        <span class="c1"># replace each key we have a value for</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>

            <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

            <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">values_to_dict</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span>

        <span class="c1"># Create dictionary of values</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># for values or keys not quoted</span>

        <span class="c1"># Split by :</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_dict_string</span>

        <span class="c1"># Trim stuff so we can get the key values</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="n">values_split_final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split</span><span class="p">:</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="n">values_split_final</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split_final</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>

                    <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>

                        <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

                    <span class="p">)</span>

        <span class="n">values_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">values_dict_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values_dict</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return expression with values replaced&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Builtins - Fudge some defaults here since we don&#39;t have runtime info</span>

        <span class="c1"># ${AWS::Region} ${AWS::AccountId}</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="p">)</span>

        <span class="c1"># Handle Sub of form [ StringToSub, { &quot;key&quot; : &quot;value&quot;, &quot;key&quot;: &quot;value&quot; }]</span>

        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_to_dict</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;: &#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if we still have them we just use their values (ie: Parameters)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_join</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the joined stuff&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">new_values_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">values_list</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>

            <span class="n">new_values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_values_list</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_if</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return both possible parts of the expression&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">value_true</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">value_false</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

        <span class="c1"># if we don&#39;t have &#39;&#39; this can break things</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">value_true</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">value_false</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Since this is runtime data the best we can do is the name in place&quot;&quot;&quot;</span>

        <span class="c1"># TODO: Allow user to inject RunTime values for these</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># pylint: disable=consider-iterating-dictionary</span>

        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">find_in_map_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mappings_map</span><span class="p">,</span> <span class="n">first_key</span><span class="p">,</span> <span class="n">final_key</span><span class="p">):</span>

        <span class="n">step1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">mappings_map</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="n">step2</span> <span class="o">=</span> <span class="n">step1</span><span class="p">[</span><span class="n">first_key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">step2</span><span class="p">[</span><span class="n">final_key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_findinmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mappings_map</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">first_key</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">final_key</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>

            <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_in_map_lookup</span><span class="p">(</span><span class="n">mappings_map</span><span class="p">,</span> <span class="n">first_key</span><span class="p">,</span> <span class="n">final_key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_getatt</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Fn::GetAtt: not supported&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">evaluate_fn_split</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Fn::Split: not supported&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_expression_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Figure out what type of expression and pass off to handler&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s2">&quot;Fn::If&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_if</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Sub&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_sub</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Join&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_join</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Ref&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_ref</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::FindInMap&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_findinmap</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::GetAtt&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_getatt</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Split&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_split</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># This is a NON expression repl { and } with ( and ) to break recursion</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">expression</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">evaluate_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Recursively find expressions in the URL and send them to be evaluated&quot;&quot;&quot;</span>

        <span class="c1"># Recursion bail out</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DEPTH</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>

                <span class="s2">&quot;Template URL contains more than </span><span class="si">{}</span><span class="s2"> levels or nesting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DEPTH</span>

                <span class="p">)</span>

            <span class="p">)</span>

        <span class="n">template_urls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Evaluate expressions</span>

        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">template_url</span><span class="p">:</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">template_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>  <span class="c1"># Last open bracket</span>

            <span class="c1"># This function will handle Fn::Sub Fn::If etc.</span>

            <span class="n">replacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_expression_controller</span><span class="p">(</span>

                <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">)</span>  <span class="c1"># First closed bracket after</span>

            <span class="k">for</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>

                <span class="n">template_url_temp</span> <span class="o">=</span> <span class="n">template_url</span>

                <span class="n">template_url_temp</span> <span class="o">=</span> <span class="n">template_url_temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>

                    <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">replacement</span>

                <span class="p">)</span>

                <span class="n">evaluated_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_string</span><span class="p">(</span>

                    <span class="n">template_url_temp</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="p">)</span>

                <span class="k">for</span> <span class="n">evaluated_string</span> <span class="ow">in</span> <span class="n">evaluated_strings</span><span class="p">:</span>

                    <span class="n">template_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluated_string</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">template_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">template_urls</span>

    <span class="k">def</span> <span class="nf">_flatten_template_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Recursively evaluate subs/ifs&quot;&quot;&quot;</span>

        <span class="n">url_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Replace ${SOMEVAR} with ##SOMEVAR## so finding actual &quot;expressions&quot; is easier</span>

        <span class="n">template_url_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">template_url_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">template_url_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_vars</span><span class="p">(</span><span class="n">template_url_string</span><span class="p">)</span>

        <span class="c1"># Evaluate expressions recursively</span>

        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">template_url_string</span><span class="p">:</span>

            <span class="n">replacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_string</span><span class="p">(</span>

                <span class="n">template_url_string</span>

            <span class="p">)</span>  <span class="c1"># first closed bracket</span>

            <span class="k">for</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>

                <span class="n">url_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">url_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url_list</span>

    <span class="k">def</span> <span class="nf">flatten_template_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Flatten template_url and return all permutations&quot;&quot;&quot;</span>

        <span class="n">path_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">url_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_template_controller</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="c1"># Extract the path portion from the URL</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>

            <span class="c1"># TODO: figure where the &#39; is coming from</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)))</span>

            <span class="n">path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">path_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">path_list</span><span class="p">))</span>

        <span class="c1"># print(url_list)</span>

        <span class="c1"># print(path_list)</span>

        <span class="k">return</span> <span class="n">path_list</span>

    <span class="nd">@staticmethod</span>

    <span class="k">def</span> <span class="nf">_remove_one_level</span><span class="p">(</span><span class="n">path_string</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">path_string</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">path_string</span><span class="p">[</span><span class="n">result</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_string</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">find_local_child_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_template_path</span><span class="p">,</span> <span class="n">child_template_path</span><span class="p">):</span>

        <span class="n">final_template_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Start where the Parent template is</span>

        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent_template_path</span><span class="p">))</span>

        <span class="c1"># Get rid of any &quot;//&quot;</span>

        <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">child_template_path</span><span class="p">)</span>

        <span class="c1"># Take the path piece by piece and try in current folder</span>

        <span class="k">while</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">):</span>

            <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_one_level</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)</span>

            <span class="n">final_template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)])</span>

            <span class="p">)</span>

            <span class="k">if</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_template_path</span><span class="p">)</span>

        <span class="c1"># Take the path piece by piece and try in one folder up folder</span>

        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent_template_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/../&quot;</span><span class="p">)</span>

        <span class="p">)</span>

        <span class="c1"># Get rid of any &quot;//&quot;</span>

        <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">child_template_path</span><span class="p">)</span>

        <span class="k">while</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">):</span>

            <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_one_level</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)</span>

            <span class="n">final_template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)])</span>

            <span class="p">)</span>

            <span class="k">if</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_template_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">template_url_to_path</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">current_template_path</span><span class="p">,</span>

        <span class="n">template_url</span><span class="p">,</span>

    <span class="p">):</span>

        <span class="n">child_local_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">child_template_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten_template_url</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="c1"># TODO: Add logic to try for S3 paths</span>

        <span class="k">for</span> <span class="n">child_template_path</span> <span class="ow">in</span> <span class="n">child_template_paths</span><span class="p">:</span>

            <span class="n">child_local_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">find_local_child_template</span><span class="p">(</span>

                    <span class="n">current_template_path</span><span class="p">,</span> <span class="n">child_template_path</span>

                <span class="p">)</span>

            <span class="p">)</span>

        <span class="k">return</span> <span class="n">child_local_paths</span>
</code></pre></div>


</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">LOG</span>
</code></pre></div>


<h2 id="classes">Classes</h2>
<h3 id="stackurlhelper">StackURLHelper</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">StackURLHelper</span><span class="p">(</span>
    <span class="n">template_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">template_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">parameter_values</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">StackURLHelper</span><span class="p">:</span>

    <span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Handle at most 20 levels of nesting in TemplateURL expressions</span>

    <span class="c1"># TODO: Allow user to inject this</span>

    <span class="c1"># SUBSTITUTION = {</span>

    <span class="c1">#     &quot;QSS3BucketName&quot;: &quot;aws-quickstart&quot;,</span>

    <span class="c1">#     &quot;QSS3KeyPrefix&quot;: &quot;QSS3KeyPrefix/&quot;,</span>

    <span class="c1">#     &quot;qss3KeyPrefix&quot;: &quot;qss3KeyPrefix/&quot;,</span>

    <span class="c1">#     &quot;AWS::Region&quot;: &quot;us-east-1&quot;,</span>

    <span class="c1">#     &quot;AWS::AccountId&quot;: &quot;8888XXXX9999&quot;,</span>

    <span class="c1"># }</span>

    <span class="n">SUBSTITUTION</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s2">&quot;AWS::Region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>

        <span class="s2">&quot;AWS::URLSuffix&quot;</span><span class="p">:</span> <span class="s2">&quot;amazonaws.com&quot;</span><span class="p">,</span>

        <span class="s2">&quot;AWS::AccountId&quot;</span><span class="p">:</span> <span class="s2">&quot;8888XXXX9999&quot;</span><span class="p">,</span>

    <span class="p">}</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">template_mappings</span><span class="o">=</span><span class="n">None</span><span class="p">,</span>

        <span class="n">template_parameters</span><span class="o">=</span><span class="n">None</span><span class="p">,</span>

        <span class="n">parameter_values</span><span class="o">=</span><span class="n">None</span><span class="p">,</span>

    <span class="p">):</span>

        <span class="k">if</span> <span class="n">template_mappings</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="n">template_mappings</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">template_parameters</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="n">template_parameters</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">parameter_values</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span> <span class="o">=</span> <span class="n">parameter_values</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">default_parameters</span><span class="p">:</span> <span class="n">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">:</span>

            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;Default&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">default_parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Default&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_values</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">rewrite_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the ${var} placeholders with ##var##&quot;&quot;&quot;</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;${&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">def</span> <span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the &#39;##var##&#39; placeholders with &#39;var&#39;&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_string</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">original_string</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># Recurse if we have more variables</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">expression</span>

        <span class="c1"># replace each key we have a value for</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>

            <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

            <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">values_to_dict</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span>

        <span class="c1"># Create dictionary of values</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># for values or keys not quoted</span>

        <span class="c1"># Split by :</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_dict_string</span>

        <span class="c1"># Trim stuff so we can get the key values</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="n">values_split_final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split</span><span class="p">:</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="n">values_split_final</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split_final</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>

                    <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>

                        <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

                    <span class="p">)</span>

        <span class="n">values_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">values_dict_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values_dict</span>

    <span class="n">def</span> <span class="n">evaluate_fn_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return expression with values replaced&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Builtins - Fudge some defaults here since we don&#39;t have runtime info</span>

        <span class="c1"># ${AWS::Region} ${AWS::AccountId}</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="p">)</span>

        <span class="c1"># Handle Sub of form [ StringToSub, { &quot;key&quot; : &quot;value&quot;, &quot;key&quot;: &quot;value&quot; }]</span>

        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_to_dict</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;: &#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if we still have them we just use their values (ie: Parameters)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">evaluate_fn_join</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the joined stuff&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">new_values_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">values_list</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>

            <span class="n">new_values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_values_list</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">evaluate_fn_if</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return both possible parts of the expression&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">value_true</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">value_false</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

        <span class="c1"># if we don&#39;t have &#39;&#39; this can break things</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">value_true</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">value_false</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="n">def</span> <span class="n">evaluate_fn_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Since this is runtime data the best we can do is the name in place&quot;&quot;&quot;</span>

        <span class="c1"># TODO: Allow user to inject RunTime values for these</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># pylint: disable=consider-iterating-dictionary</span>

        <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="n">def</span> <span class="n">find_in_map_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mappings_map</span><span class="p">,</span> <span class="n">first_key</span><span class="p">,</span> <span class="n">final_key</span><span class="p">):</span>

        <span class="n">step1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappings</span><span class="p">[</span><span class="n">mappings_map</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="n">step2</span> <span class="o">=</span> <span class="n">step1</span><span class="p">[</span><span class="n">first_key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">step2</span><span class="p">[</span><span class="n">final_key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">def</span> <span class="n">evaluate_fn_findinmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mappings_map</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">first_key</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">final_key</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>

            <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_in_map_lookup</span><span class="p">(</span><span class="n">mappings_map</span><span class="p">,</span> <span class="n">first_key</span><span class="p">,</span> <span class="n">final_key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>

        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">evaluate_fn_getatt</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="n">raise</span> <span class="n">Exception</span><span class="p">(</span><span class="s2">&quot;Fn::GetAtt: not supported&quot;</span><span class="p">)</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">evaluate_fn_split</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>

        <span class="n">raise</span> <span class="n">Exception</span><span class="p">(</span><span class="s2">&quot;Fn::Split: not supported&quot;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">evaluate_expression_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Figure out what type of expression and pass off to handler&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s2">&quot;Fn::If&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_if</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Sub&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_sub</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Join&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_join</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Ref&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_ref</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::FindInMap&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_findinmap</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::GetAtt&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_getatt</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;Fn::Split&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_fn_split</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># This is a NON expression repl { and } with ( and ) to break recursion</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">expression</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="n">def</span> <span class="n">evaluate_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Recursively find expressions in the URL and send them to be evaluated&quot;&quot;&quot;</span>

        <span class="c1"># Recursion bail out</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DEPTH</span><span class="p">:</span>

            <span class="n">raise</span> <span class="n">Exception</span><span class="p">(</span>

                <span class="s2">&quot;Template URL contains more than {} levels or nesting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DEPTH</span>

                <span class="p">)</span>

            <span class="p">)</span>

        <span class="n">template_urls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Evaluate expressions</span>

        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">template_url</span><span class="p">:</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">template_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>  <span class="c1"># Last open bracket</span>

            <span class="c1"># This function will handle Fn::Sub Fn::If etc.</span>

            <span class="n">replacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_expression_controller</span><span class="p">(</span>

                <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">)</span>  <span class="c1"># First closed bracket after</span>

            <span class="k">for</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>

                <span class="n">template_url_temp</span> <span class="o">=</span> <span class="n">template_url</span>

                <span class="n">template_url_temp</span> <span class="o">=</span> <span class="n">template_url_temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>

                    <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">replacement</span>

                <span class="p">)</span>

                <span class="n">evaluated_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_string</span><span class="p">(</span>

                    <span class="n">template_url_temp</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="p">)</span>

                <span class="k">for</span> <span class="n">evaluated_string</span> <span class="ow">in</span> <span class="n">evaluated_strings</span><span class="p">:</span>

                    <span class="n">template_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluated_string</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">template_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">template_urls</span>

    <span class="n">def</span> <span class="n">_flatten_template_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Recursively evaluate subs/ifs&quot;&quot;&quot;</span>

        <span class="n">url_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Replace ${SOMEVAR} with ##SOMEVAR## so finding actual &quot;expressions&quot; is easier</span>

        <span class="n">template_url_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">template_url_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">template_url_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_vars</span><span class="p">(</span><span class="n">template_url_string</span><span class="p">)</span>

        <span class="c1"># Evaluate expressions recursively</span>

        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">template_url_string</span><span class="p">:</span>

            <span class="n">replacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_string</span><span class="p">(</span>

                <span class="n">template_url_string</span>

            <span class="p">)</span>  <span class="c1"># first closed bracket</span>

            <span class="k">for</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>

                <span class="n">url_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">url_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url_list</span>

    <span class="n">def</span> <span class="n">flatten_template_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_url</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Flatten template_url and return all permutations&quot;&quot;&quot;</span>

        <span class="n">path_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">url_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_template_controller</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="c1"># Extract the path portion from the URL</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>

            <span class="c1"># TODO: figure where the &#39; is coming from</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)))</span>

            <span class="n">path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">path_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">path_list</span><span class="p">))</span>

        <span class="c1"># print(url_list)</span>

        <span class="c1"># print(path_list)</span>

        <span class="k">return</span> <span class="n">path_list</span>

    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">_remove_one_level</span><span class="p">(</span><span class="n">path_string</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">path_string</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">path_string</span><span class="p">[</span><span class="n">result</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">len</span><span class="p">(</span><span class="n">path_string</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">def</span> <span class="n">find_local_child_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_template_path</span><span class="p">,</span> <span class="n">child_template_path</span><span class="p">):</span>

        <span class="n">final_template_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Start where the Parent template is</span>

        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent_template_path</span><span class="p">))</span>

        <span class="c1"># Get rid of any &quot;//&quot;</span>

        <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">child_template_path</span><span class="p">)</span>

        <span class="c1"># Take the path piece by piece and try in current folder</span>

        <span class="k">while</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">):</span>

            <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_one_level</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)</span>

            <span class="n">final_template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)])</span>

            <span class="p">)</span>

            <span class="k">if</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_template_path</span><span class="p">)</span>

        <span class="c1"># Take the path piece by piece and try in one folder up folder</span>

        <span class="n">project_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent_template_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/../&quot;</span><span class="p">)</span>

        <span class="p">)</span>

        <span class="c1"># Get rid of any &quot;//&quot;</span>

        <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">child_template_path</span><span class="p">)</span>

        <span class="k">while</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">):</span>

            <span class="n">child_template_path_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_one_level</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)</span>

            <span class="n">final_template_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>

                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">project_root</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_template_path_tmp</span><span class="p">)])</span>

            <span class="p">)</span>

            <span class="k">if</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">final_template_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_template_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">def</span> <span class="n">template_url_to_path</span><span class="p">(</span>

        <span class="bp">self</span><span class="p">,</span>

        <span class="n">current_template_path</span><span class="p">,</span>

        <span class="n">template_url</span><span class="p">,</span>

    <span class="p">):</span>

        <span class="n">child_local_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">child_template_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten_template_url</span><span class="p">(</span><span class="n">template_url</span><span class="p">)</span>

        <span class="c1"># TODO: Add logic to try for S3 paths</span>

        <span class="k">for</span> <span class="n">child_template_path</span> <span class="ow">in</span> <span class="n">child_template_paths</span><span class="p">:</span>

            <span class="n">child_local_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">find_local_child_template</span><span class="p">(</span>

                    <span class="n">current_template_path</span><span class="p">,</span> <span class="n">child_template_path</span>

                <span class="p">)</span>

            <span class="p">)</span>

        <span class="k">return</span> <span class="n">child_local_paths</span>
</code></pre></div>


</details>
<hr />
<h4 id="class-variables">Class variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">MAX_DEPTH</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="n">SUBSTITUTION</span>
</code></pre></div>


<h4 id="static-methods">Static methods</h4>
<h4 id="evaluate_fn_getatt">evaluate_fn_getatt</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_getatt</span><span class="p">(</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">evaluate_fn_getatt</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="k">Exception</span><span class="p">(</span><span class="ss">&quot;Fn::GetAtt: not supported&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_if">evaluate_fn_if</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_if</span><span class="p">(</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<p>Return both possible parts of the expression</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">evaluate_fn_if</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Return both possible parts of the expression&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">value_true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">value_false</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">strip</span><span class="p">(</span><span class="ss">&quot;]&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t have &#39;&#39; this can break things</span>

<span class="s1">        results.append(&quot;&#39;</span><span class="ss">&quot; + value_true.strip(&quot;</span><span class="s1">&#39;&quot;) + &quot;&#39;</span><span class="ss">&quot;)</span>

<span class="ss">        results.append(&quot;</span><span class="s1">&#39;&quot; + value_false.strip(&quot;&#39;</span><span class="ss">&quot;) + &quot;</span><span class="err">&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">results</span><span class="w"></span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_join">evaluate_fn_join</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_join</span><span class="p">(</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<p>Return the joined stuff</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">evaluate_fn_join</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Return the joined stuff&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">new_values_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">        </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;[&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">delimiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="ss">&quot;&#39;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;[&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="k">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">values</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;]]&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"></span>

<span class="w">        </span><span class="n">values_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">values</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="ss">&quot;, &quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">values_list</span><span class="p">:</span><span class="w"></span>

<span class="w">            </span><span class="n">new_values_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="ss">&quot;&#39;&quot;</span><span class="p">))</span><span class="w"></span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delimiter</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">new_values_list</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">result</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">results</span><span class="w"></span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_split">evaluate_fn_split</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_split</span><span class="p">(</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">evaluate_fn_split</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">raise</span><span class="w"> </span><span class="k">Exception</span><span class="p">(</span><span class="ss">&quot;Fn::Split: not supported&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


</details>
<h4 id="rewrite_sub_vars_with_values">rewrite_sub_vars_with_values</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rewrite_sub_vars_with_values</span><span class="p">(</span>
    <span class="n">expression</span><span class="p">,</span>
    <span class="n">values</span>
<span class="p">)</span>
</code></pre></div>


<p>Rewrite sub vars with actual variable values</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">@staticmethod</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="k">values</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nf">replace</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">for</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">values</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="n">rep_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;##&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;##&quot;</span><span class="w"></span>

<span class="w">            </span><span class="n">rep_with</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="k">values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"></span>

<span class="w">            </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">result</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span><span class="w"> </span><span class="n">rep_with</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">result</span><span class="w"></span>
</code></pre></div>


</details>
<h4 id="values_to_dict">values_to_dict</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">values_to_dict</span><span class="p">(</span>
    <span class="n">values</span>
<span class="p">)</span>
</code></pre></div>


<p>Rewrite sub vars with actual variable values</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="err">@</span><span class="n">staticmethod</span>

    <span class="n">def</span> <span class="n">values_to_dict</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rewrite sub vars with actual variable values&quot;&quot;&quot;</span>

        <span class="c1"># Create dictionary of values</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># for values or keys not quoted</span>

        <span class="c1"># Split by :</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_dict_string</span>

        <span class="c1"># Trim stuff so we can get the key values</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split_string</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">values_split</span> <span class="o">=</span> <span class="n">values_split_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="n">values_split_final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split</span><span class="p">:</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="n">values_split_final</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_split_final</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>

                    <span class="n">values_dict_string</span> <span class="o">=</span> <span class="n">values_dict_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>

                        <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

                    <span class="p">)</span>

        <span class="n">values_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">values_dict_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values_dict</span>
</code></pre></div>


</details>
<h4 id="methods">Methods</h4>
<h4 id="evaluate_expression_controller">evaluate_expression_controller</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_expression_controller</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<p>Figure out what type of expression and pass off to handler</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">evaluate_expression_controller</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">expression</span><span class="ss">)</span>:

        <span class="s2">&quot;&quot;&quot;</span><span class="s">Figure out what type of expression and pass off to handler</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="nv">results</span> <span class="o">=</span> []

        <span class="k">if</span> <span class="s2">&quot;</span><span class="s">Fn::If</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_if</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Fn::Sub</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_sub</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Fn::Join</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_join</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Ref</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_ref</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Fn::FindInMap</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_findinmap</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Fn::GetAtt</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_getatt</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="nv">elif</span> <span class="s2">&quot;</span><span class="s">Fn::Split</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">expression</span>:

            <span class="nv">results</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_fn_split</span><span class="ss">(</span><span class="nv">expression</span><span class="ss">)</span>

        <span class="k">else</span>:

            # <span class="nv">This</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">NON</span> <span class="nv">expression</span> <span class="nv">repl</span> { <span class="nv">and</span> } <span class="nv">with</span> <span class="ss">(</span> <span class="nv">and</span> <span class="ss">)</span> <span class="nv">to</span> <span class="k">break</span> <span class="nv">recursion</span>

            <span class="nv">results</span>.<span class="nv">append</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">(</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">expression</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">)</span><span class="s2">&quot;</span><span class="ss">)</span>

        <span class="k">return</span> <span class="nv">results</span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_findinmap">evaluate_fn_findinmap</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_findinmap</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">evaluate_fn_findinmap</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">expression</span><span class="ss">)</span>:

        <span class="nb">result</span> <span class="o">=</span> []

        <span class="nv">mappings_map</span> <span class="o">=</span> <span class="nv">expression</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">[</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">1</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">]</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">0</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">,</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">0</span>].<span class="nv">strip</span><span class="ss">()</span>

        <span class="nv">first_key</span> <span class="o">=</span> <span class="nv">expression</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">[</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">1</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">]</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">0</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">,</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">1</span>].<span class="nv">strip</span><span class="ss">()</span>

        <span class="nv">final_key</span> <span class="o">=</span> <span class="nv">expression</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">[</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">1</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">]</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">0</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">,</span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">2</span>].<span class="nv">strip</span><span class="ss">()</span>

        <span class="nb">result</span>.<span class="nv">append</span><span class="ss">(</span>

            <span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">self</span>.<span class="nv">find_in_map_lookup</span><span class="ss">(</span><span class="nv">mappings_map</span>, <span class="nv">first_key</span>, <span class="nv">final_key</span><span class="ss">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span>

        <span class="ss">)</span>

        <span class="k">return</span> <span class="nb">result</span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_ref">evaluate_fn_ref</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_ref</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<p>Since this is runtime data the best we can do is the name in place</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">evaluate_fn_ref</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">expression</span><span class="ss">)</span>:

        <span class="s2">&quot;&quot;&quot;</span><span class="s">Since this is runtime data the best we can do is the name in place</span><span class="s2">&quot;&quot;&quot;</span>

        # <span class="nv">TODO</span>: <span class="nv">Allow</span> <span class="nv">user</span> <span class="nv">to</span> <span class="nv">inject</span> <span class="nv">RunTime</span> <span class="nv">values</span> <span class="k">for</span> <span class="nv">these</span>

        <span class="nv">results</span> <span class="o">=</span> []

        <span class="nv">temp</span> <span class="o">=</span> <span class="nv">expression</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">: </span><span class="s2">&quot;</span><span class="ss">)</span>[<span class="mi">1</span>]

        # <span class="nv">pylint</span>: <span class="nv">disable</span><span class="o">=</span><span class="nv">consider</span><span class="o">-</span><span class="nv">iterating</span><span class="o">-</span><span class="nv">dictionary</span>

        <span class="k">if</span> <span class="nv">temp</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)</span> <span class="nv">in</span> <span class="nv">self</span>.<span class="nv">SUBSTITUTION</span>.<span class="nv">keys</span><span class="ss">()</span>:

            <span class="nv">temp</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">SUBSTITUTION</span>[<span class="nv">temp</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)</span>]

            <span class="nv">temp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">temp</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span>

        <span class="nv">results</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">temp</span><span class="ss">)</span>

        <span class="k">return</span> <span class="nv">results</span>
</code></pre></div>


</details>
<h4 id="evaluate_fn_sub">evaluate_fn_sub</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_fn_sub</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">expression</span>
<span class="p">)</span>
</code></pre></div>


<p>Return expression with values replaced</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="n">def</span> <span class="n">evaluate_fn_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return expression with values replaced&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Builtins - Fudge some defaults here since we don&#39;t have runtime info</span>

        <span class="c1"># ${AWS::Region} ${AWS::AccountId}</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBSTITUTION</span><span class="p">)</span>

        <span class="c1"># Handle Sub of form [ StringToSub, { &quot;key&quot; : &quot;value&quot;, &quot;key&quot;: &quot;value&quot; }]</span>

        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_to_dict</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars_with_values</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">temp_expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;: &#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if we still have them we just use their values (ie: Parameters)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">temp_expression</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details>
<h4 id="evaluate_string">evaluate_string</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_string</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">template_url</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</code></pre></div>


<p>Recursively find expressions in the URL and send them to be evaluated</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">evaluate_string</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">template_url</span>, <span class="nv">depth</span><span class="o">=</span><span class="mi">0</span><span class="ss">)</span>:

        <span class="s2">&quot;&quot;&quot;</span><span class="s">Recursively find expressions in the URL and send them to be evaluated</span><span class="s2">&quot;&quot;&quot;</span>

        # <span class="nv">Recursion</span> <span class="nv">bail</span> <span class="nv">out</span>

        <span class="k">if</span> <span class="nv">depth</span> <span class="o">&gt;</span> <span class="nv">self</span>.<span class="nv">MAX_DEPTH</span>:

            <span class="nv">raise</span> <span class="nv">Exception</span><span class="ss">(</span>

                <span class="s2">&quot;</span><span class="s">Template URL contains more than {} levels or nesting</span><span class="s2">&quot;</span>.<span class="nv">format</span><span class="ss">(</span>

                    <span class="nv">self</span>.<span class="nv">MAX_DEPTH</span>

                <span class="ss">)</span>

            <span class="ss">)</span>

        <span class="nv">template_urls</span> <span class="o">=</span> []

        # <span class="nv">Evaluate</span> <span class="nv">expressions</span>

        <span class="k">if</span> <span class="s2">&quot;</span><span class="s">{</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">template_url</span>:

            <span class="nv">parts</span> <span class="o">=</span> <span class="nv">template_url</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">{</span><span class="s2">&quot;</span><span class="ss">)</span>

            <span class="nv">parts</span> <span class="o">=</span> <span class="nv">parts</span>[<span class="o">-</span><span class="mi">1</span>].<span class="nv">split</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">}</span><span class="s2">&quot;</span><span class="ss">)</span>  # <span class="nv">Last</span> <span class="nv">open</span> <span class="nv">bracket</span>

            # <span class="nv">This</span> <span class="nv">function</span> <span class="nv">will</span> <span class="nv">handle</span> <span class="nv">Fn</span>::<span class="nv">Sub</span> <span class="nv">Fn</span>::<span class="k">If</span> <span class="nv">etc</span>.

            <span class="nv">replacements</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_expression_controller</span><span class="ss">(</span>

                <span class="nv">parts</span>[<span class="mi">0</span>]

            <span class="ss">)</span>  # <span class="nv">First</span> <span class="nv">closed</span> <span class="nv">bracket</span> <span class="nv">after</span>

            <span class="k">for</span> <span class="nv">replacement</span> <span class="nv">in</span> <span class="nv">replacements</span>:

                <span class="nv">template_url_temp</span> <span class="o">=</span> <span class="nv">template_url</span>

                <span class="nv">template_url_temp</span> <span class="o">=</span> <span class="nv">template_url_temp</span>.<span class="nv">replace</span><span class="ss">(</span>

                    <span class="s2">&quot;</span><span class="s">{</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">parts</span>[<span class="mi">0</span>] <span class="o">+</span> <span class="s2">&quot;</span><span class="s">}</span><span class="s2">&quot;</span>, <span class="nv">replacement</span>

                <span class="ss">)</span>

                <span class="nv">evaluated_strings</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">evaluate_string</span><span class="ss">(</span>

                    <span class="nv">template_url_temp</span>, <span class="nv">depth</span><span class="o">=</span><span class="ss">(</span><span class="nv">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="ss">)</span>

                <span class="ss">)</span>

                <span class="k">for</span> <span class="nv">evaluated_string</span> <span class="nv">in</span> <span class="nv">evaluated_strings</span>:

                    <span class="nv">template_urls</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">evaluated_string</span><span class="ss">)</span>

        <span class="k">else</span>:

            <span class="nv">template_urls</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">template_url</span><span class="ss">)</span>

        <span class="k">return</span> <span class="nv">template_urls</span>
</code></pre></div>


</details>
<h4 id="find_in_map_lookup">find_in_map_lookup</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">find_in_map_lookup</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mappings_map</span><span class="p">,</span>
    <span class="n">first_key</span><span class="p">,</span>
    <span class="n">final_key</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">find_in_map_lookup</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">mappings_map</span>, <span class="nv">first_key</span>, <span class="nv">final_key</span><span class="ss">)</span>:

        <span class="nv">step1</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">mappings</span>[<span class="nv">mappings_map</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)</span>]

        <span class="nv">step2</span> <span class="o">=</span> <span class="nv">step1</span>[<span class="nv">first_key</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)</span>]

        <span class="nb">result</span> <span class="o">=</span> <span class="nv">step2</span>[<span class="nv">final_key</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)</span>]

        <span class="k">return</span> <span class="nb">result</span>
</code></pre></div>


</details>
<h4 id="find_local_child_template">find_local_child_template</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">find_local_child_template</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">parent_template_path</span><span class="p">,</span>
    <span class="n">child_template_path</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">find_local_child_template</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">parent_template_path</span>, <span class="nv">child_template_path</span><span class="ss">)</span>:

        <span class="nv">final_template_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        # <span class="nv">Start</span> <span class="nv">where</span> <span class="nv">the</span> <span class="nv">Parent</span> <span class="nv">template</span> <span class="nv">is</span>

        <span class="nv">project_root</span> <span class="o">=</span> <span class="nv">Path</span><span class="ss">(</span><span class="nv">os</span>.<span class="nv">path</span>.<span class="k">dirname</span><span class="ss">(</span><span class="nv">parent_template_path</span><span class="ss">))</span>

        # <span class="nv">Get</span> <span class="nv">rid</span> <span class="nv">of</span> <span class="nv">any</span> <span class="s2">&quot;</span><span class="s">//</span><span class="s2">&quot;</span>

        <span class="nv">child_template_path_tmp</span> <span class="o">=</span> <span class="nv">os</span>.<span class="nv">path</span>.<span class="nv">normpath</span><span class="ss">(</span><span class="nv">child_template_path</span><span class="ss">)</span>

        # <span class="nv">Take</span> <span class="nv">the</span> <span class="nv">path</span> <span class="nv">piece</span> <span class="nv">by</span> <span class="nv">piece</span> <span class="nv">and</span> <span class="nv">try</span> <span class="nv">in</span> <span class="nv">current</span> <span class="nv">folder</span>

        <span class="k">while</span> <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">str</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>:

            <span class="nv">child_template_path_tmp</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">_remove_one_level</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>

            <span class="nv">final_template_path</span> <span class="o">=</span> <span class="nv">Path</span><span class="ss">(</span>

                <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span>.<span class="nv">join</span><span class="ss">(</span>[<span class="nv">str</span><span class="ss">(</span><span class="nv">project_root</span><span class="ss">)</span>, <span class="nv">str</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>]<span class="ss">)</span>

            <span class="ss">)</span>

            <span class="k">if</span> <span class="nv">final_template_path</span>.<span class="nv">exists</span><span class="ss">()</span> <span class="nv">and</span> <span class="nv">final_template_path</span>.<span class="nv">is_file</span><span class="ss">()</span>:

                <span class="k">return</span> <span class="nv">str</span><span class="ss">(</span><span class="nv">final_template_path</span><span class="ss">)</span>

        # <span class="nv">Take</span> <span class="nv">the</span> <span class="nv">path</span> <span class="nv">piece</span> <span class="nv">by</span> <span class="nv">piece</span> <span class="nv">and</span> <span class="nv">try</span> <span class="nv">in</span> <span class="nv">one</span> <span class="nv">folder</span> <span class="nv">up</span> <span class="nv">folder</span>

        <span class="nv">project_root</span> <span class="o">=</span> <span class="nv">Path</span><span class="ss">(</span>

            <span class="nv">os</span>.<span class="nv">path</span>.<span class="nv">normpath</span><span class="ss">(</span><span class="nv">os</span>.<span class="nv">path</span>.<span class="k">dirname</span><span class="ss">(</span><span class="nv">parent_template_path</span><span class="ss">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">/../</span><span class="s2">&quot;</span><span class="ss">)</span>

        <span class="ss">)</span>

        # <span class="nv">Get</span> <span class="nv">rid</span> <span class="nv">of</span> <span class="nv">any</span> <span class="s2">&quot;</span><span class="s">//</span><span class="s2">&quot;</span>

        <span class="nv">child_template_path_tmp</span> <span class="o">=</span> <span class="nv">os</span>.<span class="nv">path</span>.<span class="nv">normpath</span><span class="ss">(</span><span class="nv">child_template_path</span><span class="ss">)</span>

        <span class="k">while</span> <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="nv">str</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>:

            <span class="nv">child_template_path_tmp</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">_remove_one_level</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>

            <span class="nv">final_template_path</span> <span class="o">=</span> <span class="nv">Path</span><span class="ss">(</span>

                <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span>.<span class="nv">join</span><span class="ss">(</span>[<span class="nv">str</span><span class="ss">(</span><span class="nv">project_root</span><span class="ss">)</span>, <span class="nv">str</span><span class="ss">(</span><span class="nv">child_template_path_tmp</span><span class="ss">)</span>]<span class="ss">)</span>

            <span class="ss">)</span>

            <span class="k">if</span> <span class="nv">final_template_path</span>.<span class="nv">exists</span><span class="ss">()</span> <span class="nv">and</span> <span class="nv">final_template_path</span>.<span class="nv">is_file</span><span class="ss">()</span>:

                <span class="k">return</span> <span class="nv">str</span><span class="ss">(</span><span class="nv">final_template_path</span><span class="ss">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>


</details>
<h4 id="flatten_template_url">flatten_template_url</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">flatten_template_url</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">template_url</span>
<span class="p">)</span>
</code></pre></div>


<p>Flatten template_url and return all permutations</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">flatten_template_url</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">template_url</span><span class="ss">)</span>:

        <span class="s2">&quot;&quot;&quot;</span><span class="s">Flatten template_url and return all permutations</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="nv">path_list</span> <span class="o">=</span> []

        <span class="nv">url_list</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">_flatten_template_controller</span><span class="ss">(</span><span class="nv">template_url</span><span class="ss">)</span>

        # <span class="nv">Extract</span> <span class="nv">the</span> <span class="nv">path</span> <span class="nv">portion</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">URL</span>

        <span class="k">for</span> <span class="nv">url</span> <span class="nv">in</span> <span class="nv">url_list</span>:

            # <span class="nv">TODO</span>: <span class="nv">figure</span> <span class="nv">where</span> <span class="nv">the</span> <span class="s1">&#39;</span><span class="s"> is coming from</span>

            <span class="nv">output</span> <span class="o">=</span> <span class="nv">urlparse</span><span class="ss">(</span><span class="nv">str</span><span class="ss">(</span><span class="nv">url</span>.<span class="nv">strip</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span><span class="ss">)))</span>

            <span class="nv">path_list</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">output</span>.<span class="nv">path</span><span class="ss">)</span>

        <span class="nv">path_list</span> <span class="o">=</span> <span class="nv">list</span><span class="ss">(</span><span class="nv">dict</span>.<span class="nv">fromkeys</span><span class="ss">(</span><span class="nv">path_list</span><span class="ss">))</span>

        # <span class="nv">print</span><span class="ss">(</span><span class="nv">url_list</span><span class="ss">)</span>

        # <span class="nv">print</span><span class="ss">(</span><span class="nv">path_list</span><span class="ss">)</span>

        <span class="k">return</span> <span class="nv">path_list</span>
</code></pre></div>


</details>
<h4 id="rewrite_sub_vars">rewrite_sub_vars</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rewrite_sub_vars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">original_string</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>


<p>Replace the '##var##' placeholders with 'var'</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="n">def</span> <span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the &#39;##var##&#39; placeholders with &#39;var&#39;&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_string</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">original_string</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;##&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># Recurse if we have more variables</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_sub_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


</details>
<h4 id="rewrite_vars">rewrite_vars</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rewrite_vars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">original_string</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>


<p>Replace the ${var} placeholders with ##var##</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="n">def</span> <span class="n">rewrite_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Replace the ${var} placeholders with ##var##&quot;&quot;&quot;</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">rep_text</span> <span class="o">=</span> <span class="s2">&quot;${&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

        <span class="n">rep_with</span> <span class="o">=</span> <span class="s2">&quot;##&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;##&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">original_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rep_text</span><span class="p">,</span> <span class="n">rep_with</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_vars</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


</details>
<h4 id="template_url_to_path">template_url_to_path</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">template_url_to_path</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">current_template_path</span><span class="p">,</span>
    <span class="n">template_url</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code>    <span class="nv">def</span> <span class="nv">template_url_to_path</span><span class="ss">(</span>

        <span class="nv">self</span>,

        <span class="nv">current_template_path</span>,

        <span class="nv">template_url</span>,

    <span class="ss">)</span>:

        <span class="nv">child_local_paths</span> <span class="o">=</span> []

        <span class="nv">child_template_paths</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">flatten_template_url</span><span class="ss">(</span><span class="nv">template_url</span><span class="ss">)</span>

        # <span class="nv">TODO</span>: <span class="nv">Add</span> <span class="nv">logic</span> <span class="nv">to</span> <span class="nv">try</span> <span class="k">for</span> <span class="nv">S3</span> <span class="nv">paths</span>

        <span class="k">for</span> <span class="nv">child_template_path</span> <span class="nv">in</span> <span class="nv">child_template_paths</span>:

            <span class="nv">child_local_paths</span>.<span class="nv">append</span><span class="ss">(</span>

                <span class="nv">self</span>.<span class="nv">find_local_child_template</span><span class="ss">(</span>

                    <span class="nv">current_template_path</span>, <span class="nv">child_template_path</span>

                <span class="ss">)</span>

            <span class="ss">)</span>

        <span class="k">return</span> <span class="nv">child_local_paths</span>
</code></pre></div>


</details>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../stack/" title="Stack" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Stack
              </span>
            </div>
          </a>
        
        
          <a href="../template/" title="Template" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Template
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>